<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - OskarTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html"><i class="fas fa-eye"></i> OskarTrack AI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="live.html"><i class="fas fa-video"></i> Live</a></li>
                    <li class="nav-item"><a class="nav-link" href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="zones.html"><i class="fas fa-map-marked-alt"></i> Zones</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <h2 class="mb-4"><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="dashboard-card">
                    <h6 class="text-muted">Today's Visitors</h6>
                    <h2 id="todayVisitors" class="text-primary">0</h2>
                    <small class="text-success"><i class="fas fa-arrow-up"></i> vs yesterday</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card">
                    <h6 class="text-muted">Unique Customers</h6>
                    <h2 id="uniqueCustomers" class="text-success">0</h2>
                    <small>New: <span id="newCustomers">0</span></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card">
                    <h6 class="text-muted">Avg Duration</h6>
                    <h2 id="avgDuration" class="text-warning">0m</h2>
                    <small>Time spent in store</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card">
                    <h6 class="text-muted">Peak Hour</h6>
                    <h2 id="peakHour" class="text-info">-</h2>
                    <small>Most busy time</small>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row">
            <div class="col-md-8">
                <div class="chart-container">
                    <h4><i class="fas fa-clock"></i> Hourly Visitor Distribution</h4>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <h4><i class="fas fa-users"></i> Visitor Types</h4>
                    <canvas id="visitorTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-map-marker-alt"></i> Zone Performance</h4>
                    <canvas id="zoneChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4><i class="fas fa-calendar-week"></i> 7-Day Trend</h4>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="script.js"></script>
    <script>
        let hourlyChart, visitorTypeChart, zoneChart, trendChart;

        async function loadDashboard() {
            try {
                // Load daily stats
                const dailyResponse = await fetch('/api/analytics/daily');
                const dailyData = await dailyResponse.json();
                
                document.getElementById('todayVisitors').textContent = dailyData.total_visitors || 0;
                document.getElementById('uniqueCustomers').textContent = dailyData.unique_visitors || 0;
                document.getElementById('newCustomers').textContent = dailyData.unique_visitors || 0;
                document.getElementById('avgDuration').textContent = Math.round(dailyData.average_duration / 60) + 'm';

                // Load hourly distribution
                const hourlyResponse = await fetch('/api/analytics/hourly');
                const hourlyData = await hourlyResponse.json();
                updateHourlyChart(hourlyData.hourly_data);

                // Find peak hour
                const maxHour = Object.entries(hourlyData.hourly_data)
                    .reduce((a, b) => b[1] > a[1] ? b : a);
                document.getElementById('peakHour').textContent = maxHour[0] + ':00';

                // Load zone stats
                const zoneResponse = await fetch('/api/analytics/zones');
                const zoneData = await zoneResponse.json();
                updateZoneChart(zoneData.zones);

                // Load 7-day trend
                const trendResponse = await fetch('/api/analytics/summary?days=7');
                const trendData = await trendResponse.json();
                updateTrendChart(trendData.summary);

                // Visitor type pie chart (mock data for now)
                updateVisitorTypeChart({
                    new: dailyData.unique_visitors,
                    returning: dailyData.returning_visitors
                });

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChart) hourlyChart.destroy();
            
            const hours = Object.keys(data).map(h => h + ':00');
            const values = Object.values(data);

            hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Visitors per Hour',
                        data: values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateVisitorTypeChart(data) {
            const ctx = document.getElementById('visitorTypeChart').getContext('2d');
            if (visitorTypeChart) visitorTypeChart.destroy();

            visitorTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New Visitors', 'Returning'],
                    datasets: [{
                        data: [data.new || 0, data.returning || 0],
                        backgroundColor: ['#36a2eb', '#ff6384']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateZoneChart(zones) {
            const ctx = document.getElementById('zoneChart').getContext('2d');
            if (zoneChart) zoneChart.destroy();

            zoneChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: zones.map(z => z.name),
                    datasets: [{
                        label: 'Visitors',
                        data: zones.map(z => z.total_visitors),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateTrendChart(summary) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            const reversed = summary.reverse();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: reversed.map(s => s.date),
                    datasets: [{
                        label: 'Daily Visitors',
                        data: reversed.map(s => s.total_visitors),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        loadDashboard();
        setInterval(loadDashboard, 60000); // Refresh every minute
    </script>
</body>
</html>
