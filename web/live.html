<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tracking - OskarTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html"><i class="fas fa-eye"></i> OskarTrack AI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="live.html"><i class="fas fa-video"></i> Live</a></li>
                    <li class="nav-item"><a class="nav-link" href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="zones.html"><i class="fas fa-map-marked-alt"></i> Zones</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <span class="live-indicator"></span>
                Live Tracking
            </h2>
            <div>
                <span class="badge bg-success">Active Visitors: <span id="activeCount">0</span></span>
            </div>
        </div>

        <div class="row">
            <!-- Upload Section -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h4><i class="fas fa-upload"></i> Upload Image/Video</h4>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <p>Click or drag files here to analyze</p>
                        <input type="file" id="fileInput" accept="image/*,video/*" class="d-none">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            Choose File
                        </button>
                    </div>
                    <div id="uploadProgress" class="mt-3 hidden">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="resultArea" class="mt-3"></div>
                </div>
            </div>

            <!-- Current Activity -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h4><i class="fas fa-chart-line"></i> Real-time Activity</h4>
                    <div class="activity-log" id="activityLog">
                        <p class="text-muted text-center">Waiting for activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Visits Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h4><i class="fas fa-users"></i> Currently Active Visits</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Customer ID</th>
                                    <th>Entry Time</th>
                                    <th>Duration</th>
                                    <th>Current Zone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="activeVisitsTable">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No active visits</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const resultArea = document.getElementById('resultArea');

        fileInput.addEventListener('change', handleFileUpload);

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });

        async function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            uploadProgress.classList.remove('hidden');
            progressBar.style.width = '50%';
            resultArea.innerHTML = '';

            try {
                const endpoint = file.type.startsWith('image/') ? '/api/process/image' : '/api/process/video';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '100%';
                const data = await response.json();

                resultArea.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Processing Complete!</h5>
                        <p><strong>Persons Detected:</strong> ${data.person_count || data.max_persons_detected || 0}</p>
                        ${data.total_frames ? `<p><strong>Total Frames:</strong> ${data.total_frames}</p>` : ''}
                        ${data.average_persons ? `<p><strong>Average Persons:</strong> ${data.average_persons.toFixed(2)}</p>` : ''}
                    </div>
                `;

                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 2000);

            } catch (error) {
                resultArea.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                uploadProgress.classList.add('hidden');
            }
        }

        // Load active visits
        async function loadActiveVisits() {
            try {
                const response = await fetch('/api/visits/active');
                const visits = await response.json();
                
                document.getElementById('activeCount').textContent = visits.length;

                const tbody = document.getElementById('activeVisitsTable');
                if (visits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No active visits</td></tr>';
                } else {
                    tbody.innerHTML = visits.map(visit => `
                        <tr>
                            <td><strong>${visit.customer_id}</strong></td>
                            <td>${new Date(visit.entry_time).toLocaleTimeString()}</td>
                            <td>${Math.floor(visit.duration / 60)}m ${Math.floor(visit.duration % 60)}s</td>
                            <td><span class="zone-badge zone-product">-</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="endVisit(${visit.id})">
                                    End Visit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading active visits:', error);
            }
        }

        async function endVisit(visitId) {
            try {
                await fetch(`/api/visits/${visitId}/end`, { method: 'POST' });
                loadActiveVisits();
            } catch (error) {
                alert('Error ending visit: ' + error.message);
            }
        }

        // WebSocket for real-time updates
        let ws;
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addActivityLog(data);
            };

            ws.onerror = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        function addActivityLog(data) {
            const log = document.getElementById('activityLog');
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                <strong>${data.type}:</strong> ${JSON.stringify(data.data)}
            `;
            log.insertBefore(item, log.firstChild);

            // Keep only last 20 items
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        loadActiveVisits();
        setInterval(loadActiveVisits, 5000);
        connectWebSocket();
    </script>
</body>
</html>
